<?php
declare(strict_types=1);

namespace UnknownOre\AntiExploit;

use pocketmine\event\EventPriority;
use pocketmine\event\server\DataPacketReceiveEvent;
use pocketmine\network\mcpe\protocol\InventoryTransactionPacket;
use pocketmine\network\mcpe\protocol\ProtocolInfo;
use pocketmine\plugin\PluginBase;
use function count;

class Main extends PluginBase{

	public function onEnable():void{
		$this->getServer()->getPluginManager()->registerEvent(DataPacketReceiveEvent::class, function(DataPacketReceiveEvent $event): void{
			$packet = $event->getPacket();
			if($packet->pid() === ProtocolInfo::INVENTORY_TRANSACTION_PACKET){
				/** @var InventoryTransactionPacket $packet */
				if(count($packet->trData->getActions()) > 640) {
					$event->cancel();
					$ip = $event->getOrigin()->getIp();
					$this->getServer()->getNetwork()->blockAddress($ip);
					$this->getLogger()->alert("Blocked '__nuke' attack from $ip");
				}
			}
		}, EventPriority::LOWEST, $this);
	}

}
